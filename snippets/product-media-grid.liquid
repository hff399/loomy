{% liquid
  assign image_size = section.settings.image_ratio
  if image_size == 'landscape'
    assign imageratio = '70'
  elsif image_size == 'square'
    assign imageratio = '100'
  elsif image_size == 'portrait'
    assign imageratio = '130'
  else
    assign imageratio = '120'
  endif
%}
<product-media-gallery
  data-id="{{ section.id }}"
  data-media-gallery-style="media-grid"
   data-thumbnails-style="{{ thumbnails_style }}"
  data-source="{{ source }}"
>
  <div class="product-main-media-wrapper {{ image_size }}">
    {% if product != empty %}
      {% if product.media.size > 0 %}
        {% if product.media.size > 1 %}
          <div class="swiper" data-main-media>
            <div class="swiper-wrapper">
        {% endif %}
        {%- if product.selected_or_first_available_variant.featured_media != null -%}
          {% liquid
            if image_size == 'auto'
              assign imageratio = 1 | divided_by: product.selected_or_first_available_variant.featured_media.aspect_ratio | times: 100 | minus: 1
            endif
          %}
          {%- assign featured_media = product.selected_or_first_available_variant.featured_media -%}
          <div
            class="product-image-slideshow-item{% if product.media.size > 1 %} swiper-slide{% endif %}"
            data-media-id="{{ section.id }}-{{ featured_media.id }}"
          >
            <div class="product-image-slideshow-media">
              {% if enable_zoom %}
                <media-zoom-button data-section="{{ section.id }}" data-image="{{ section.id }}-{{ featured_media.id }}"></media-zoom-button>
              {% endif %}
              <div class="media" style="--image-ratio:{{ imageratio }}%;">
                {% comment %} {% render 'lazy-images', image: featured_media %} {% endcomment %}
                {{
                  featured_media
                  | image_url: width: 3000
                  | image_tag: sizes: '100vw', widths: '550, 720, 990, 1100, 1500, 2200, 3000'
                }}
              </div>
            </div>
          </div>
        {%- endif -%}
        {% for media in product.media %}
          {% unless media.id == currentVariant.featured_media.id %}
            {% liquid
              if image_size == 'auto'
                assign imageratio = 1 | divided_by: media.preview_image.aspect_ratio | times: 100 | minus: 1
              endif
            %}

            <div
              class="product-image-slideshow-item{% if product.media.size > 1 %} swiper-slide{% endif %}"
              data-media-id="{{ section.id }}-{{ media.id }}"
            >
              <div class="product-image-slideshow-media">
                {% if enable_zoom and media.media_type == 'image' %}
                  <media-zoom-button data-section="{{ section.id }}" data-image="{{ section.id }}-{{ media.id }}"></media-zoom-button>
                {% endif %}
                <div class="media" style="--image-ratio:{{ imageratio }}%;">
                  {% case media.media_type %}
                    {% when 'image' %}
                      {% if forloop.index > 3 %}
                        {% render 'lazy-images', image: media %}
                      {% else %}
                        {{
                          media
                          | image_url: width: 3000
                          | image_tag: sizes: '100vw', widths: '550, 720, 990, 1100, 1500, 2200, 3000'
                        }}
                      {% endif %}
                    {%- when 'video' -%}
                      <deferred-media-video
                        class="deferred-media"
                        class="deferred-media autoplay-status-true"
                        id="deffered-{{ media.media_type }}-{{ section.id }}"
                        data-type="{{ media.media_type }}"
                      >
                        {{
                          media
                          | media_tag:
                            loading: 'lazy',
                            class: 'no-js-hidden product-media-video',
                            autoplay: video_autoplay,
                            loop: video_looping,
                            controls: true,
                            preload: 'none'
                        }}
                      </deferred-media-video>
                    {%- when 'external_video' -%}
                      {% liquid
                      assign videourl =  media | external_video_url
                        assign videoclass = 'youtube-video'
                        if videourl contains 'vimeo'
                          assign videoclass = 'vimeo-video'
                        endif
                      %}
                      <deferred-media-video
                        class="deferred-media autoplay-status-true external-video"
                        id="deffered-{{ media.media_type }}-{{ section.id }}"
                        data-type="{{ media.media_type }}"
                        data-autoplay="{{ video_autoplay }}"
                        data-loop="{{ video_looping }}"
                      >
                        {%- if media.host == 'youtube' -%}
                          {%- assign youtube_origin = shop.url  -%}
                          {% if video_autoplay %}
                            {% assign autoplay_count = 1 %}
                          {% else %}
                            {% assign autoplay_count = 0 %}
                          {% endif %}
                          {%- assign youtube_url = "https://www.youtube.com/embed/" | append: media.external_id | append: "?autoplay="| append: autoplay_count | append: "&controls=1&enablejsapi=1&loop=" | append: video_looping | append: "&playlist=" | append: media.external_id | append: "&modestbranding=1&playsinline=1&rel=0&origin=" | append: youtube_origin -%}
                          <iframe  src="{{ youtube_url }}" class="{{ videoclass }}" id="youtube-video-iframe-{{ media.external_id }}-{{ section.id }}" loading="lazy" allow="autoplay; encrypted-media;" allowfullscreen></iframe>
                        {%- elsif media.host == 'vimeo' -%}
                          {{ media | external_video_url: autoplay: video_autoplay, loop: video_looping, api: true | external_video_tag: class: videoclass, loading: 'lazy' }}
                        {%- endif -%}
                      </deferred-media-video>
                    {%- when 'model' -%}
                      <product-model> 
                        {{
                          media
                          | model_viewer_tag:
                            image_size: true,
                            reveal: 'interaction',
                            toggleable: true,
                            data-model-id: media.id
                        }}
                        <button class="close-product-model hidden">
                          <svg width="12" height="12" viewBox="0 0 22 22" fill="none">
                            <path d="M21.7987 20.826L11.9721 10.9958L21.7987 1.16552C22.0561 0.899047 22.0561 0.476499 21.7987 0.20994C21.5349 -0.0632507 21.0997 -0.0708067 20.8266 0.193065L11 10.0233L1.17343 0.193149C0.907055 -0.0642582 0.484664 -0.0642582 0.218204 0.193149C-0.0548867 0.457021 -0.0624398 0.892415 0.201335 1.16561L10.0279 10.9958L0.201335 20.826C0.0724268 20.9549 1.71925e-08 21.1298 1.71925e-08 21.3122C-8.39964e-05 21.692 0.307751 21.9999 0.687425 22C0.869793 22.0002 1.04469 21.9276 1.17343 21.7984L11 11.9682L20.8266 21.7985C20.9553 21.9277 21.1303 22.0002 21.3127 22C21.4949 21.9999 21.6696 21.9275 21.7985 21.7987C22.0671 21.5301 22.0672 21.0946 21.7987 20.826Z" fill="currentColor"></path>
                          </svg>
                        </button>
                        <button
                          class="button button--full-width product__xr-button"
                          type="button"
                          aria-label="{{ 'products.product.xr_button_label' | t }}"
                          data-shopify-xr
                          data-shopify-model3d-id="{{ media.id }}"
                          data-shopify-title="{{ product.title | escape }}"
                          data-shopify-xr-hidden
                        >
                          {{ 'products.product.xr_button' | t }}
                        </button>
                      </product-model>
                  {% endcase %}
                </div>
              </div>
            </div>
          {% endunless %}
        {% endfor %}
        {% if product.media.size > 1 %}
          </div>
          <div class="swiper-button-wrapper">
            <div class="slideshow-nav-btn slideshow-prev cursor-pointer swiper-main-button-prev-{{ section.id }} arrow-style-{{ settings.arrow_style }}" data-product-swiper-prev>
              {% if settings.arrow_style == 'star' %}
                {% render 'svg-icons', icon: 'star-arrow-prev' %}
              {% else %}
                {% render 'svg-icons', icon: 'arrow-icon-prev' %}
              {% endif %}
            </div>
            <div class="slideshow-nav-btn slideshow-next cursor-pointer swiper-main-button-next-{{ section.id }} arrow-style-{{ settings.arrow_style }}" data-product-swiper-next>
              {% if settings.arrow_style == 'star' %}
                {% render 'svg-icons', icon: 'star-arrow-next' %}
              {% else %}
                {% render 'svg-icons', icon: 'arrow-icon-next' %}
              {% endif %}
            </div>
          </div>
          </div>
        {% endif %}
      {% else %}
        <div class="product-image-slideshow-item">
          <div class="product-image-slideshow-media">
            <div class="media" style="--image-ratio:{{ imageratio }}%;">
              {{ 'product-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          </div>
        </div>
      {% endif %}
    {% else %}
      <div class="product-image-slideshow-item">
        <div class="product-image-slideshow-media">
          <div class="media" style="--image-ratio:{{ imageratio }}%;">
            {{ 'product-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
  {% if product.media.size > 1 %}
    <div class="product-thumbnails-media-wrapper{% if thumbnails_style == 'none' %} hidden{% endif %}{% if hide_thumbnails_mobile %} hide-thumbnails-mobile{% endif %}">
      <div
        class="swiper"
        data-thumbnails-media
      >
        <div class="swiper-wrapper">
          {%- if product.selected_or_first_available_variant.featured_media != null -%}
            {%- assign featured_media = product.selected_or_first_available_variant.featured_media -%}
            <div class="product-thumbnails-media-item swiper-slide">
              <div class="product-thumbnails-media-img">
                <div class="media media-fixed">
                  {%- render 'lazy-images', image: featured_media -%}
                </div>
              </div>
            </div>
          {%- endif -%}
          {% for media in product.media %}
            {% unless media.id == currentVariant.featured_media.id %}
              <div class="product-thumbnails-media-item swiper-slide">
                <div class="product-thumbnails-media-img">
                  <div class="media media-fixed">
                    {%- render 'lazy-images', image: media -%}
                  </div>
                </div>
              </div>
            {% endunless %}
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</product-media-gallery>
