{% comment %}
  Reima-Style Collection Navigation
  Generates navigation tabs from Shopify collections with dropdowns

  Usage:
  {% render 'reima-nav-collections', collections_to_show: 'boys,girls,sale' %}
{% endcomment %}

{% comment %} Configuration {% endcomment %}
{% assign nav_collections = collections_to_show | default: '' | strip %}
{% assign auto_mode = auto_populate | default: false %}
{% assign max_nav_items = max_items | default: 8 %}
{% assign show_sale = show_sale_tab | default: true %}
{% assign show_new = show_new_arrivals | default: false %}

{% comment %} Build collection handles list {% endcomment %}
{% assign collection_handles = '' | split: ',' %}

{% if nav_collections != blank %}
  {% comment %} Parse the user-provided collection handles {% endcomment %}
  {% assign raw_handles = nav_collections | split: ',' %}
  {% for raw in raw_handles %}
    {% assign clean_handle = raw | strip | handleize %}
    {% if clean_handle != blank %}
      {% assign collection_handles = collection_handles | push: clean_handle %}
    {% endif %}
  {% endfor %}
{% endif %}

{% comment %} Auto-populate if no handles provided or auto mode enabled {% endcomment %}
{% if collection_handles.size == 0 and auto_mode %}
  {% assign count = 0 %}
  {% for coll in collections %}
    {% if count < max_nav_items %}
      {% if coll.products.size > 0 and coll.handle != 'all' and coll.handle != 'frontpage' %}
        {% assign collection_handles = collection_handles | push: coll.handle %}
        {% assign count = count | plus: 1 %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

<nav class="reima-coll-nav" aria-label="Collections navigation">
  <ul class="reima-coll-nav-list">
    {% comment %} Sale tab first if enabled {% endcomment %}
    {% if show_sale %}
      {% assign sale_coll = collections['sale'] %}
      {% if sale_coll != blank %}
        <li class="reima-coll-nav-item reima-coll-sale" data-nav-item>
          <a href="{{ sale_coll.url }}" class="reima-coll-nav-link sale-link">Sale</a>
          {% if sale_coll.products.size > 0 %}
            <div class="reima-coll-dropdown" data-dropdown>
              <div class="reima-coll-dropdown-inner">
                <div class="reima-coll-dropdown-col">
                  <h4 class="reima-coll-dropdown-title">SHOP SALE</h4>
                  <ul class="reima-coll-dropdown-list">
                    {% for product in sale_coll.products limit: 6 %}
                      <li><a href="{{ product.url }}">{{ product.title | truncate: 40 }}</a></li>
                    {% endfor %}
                  </ul>
                  <a href="{{ sale_coll.url }}" class="reima-coll-see-all">View All Sale →</a>
                </div>
              </div>
            </div>
          {% endif %}
        </li>
      {% endif %}
    {% endif %}

    {% comment %} New Arrivals tab if enabled {% endcomment %}
    {% if show_new %}
      {% assign new_coll = collections['new-arrivals'] %}
      {% if new_coll != blank %}
        <li class="reima-coll-nav-item reima-coll-new" data-nav-item>
          <a href="{{ new_coll.url }}" class="reima-coll-nav-link">New Arrivals</a>
          {% if new_coll.products.size > 0 %}
            <div class="reima-coll-dropdown" data-dropdown>
              <div class="reima-coll-dropdown-inner">
                <div class="reima-coll-dropdown-col">
                  <h4 class="reima-coll-dropdown-title">NEW ARRIVALS</h4>
                  <ul class="reima-coll-dropdown-list">
                    {% for product in new_coll.products limit: 6 %}
                      <li><a href="{{ product.url }}">{{ product.title | truncate: 40 }}</a></li>
                    {% endfor %}
                  </ul>
                  <a href="{{ new_coll.url }}" class="reima-coll-see-all">View All New →</a>
                </div>
              </div>
            </div>
          {% endif %}
        </li>
      {% endif %}
    {% endif %}

    {% comment %} Regular collection tabs {% endcomment %}
    {% for handle in collection_handles %}
      {% assign coll = collections[handle] %}

      {% if coll != blank %}
        <li class="reima-coll-nav-item" data-nav-item>
          <a href="{{ coll.url }}" class="reima-coll-nav-link">{{ coll.title }}</a>

          {% comment %} Always show dropdown with products {% endcomment %}
          {% if coll.products.size > 0 %}
            <div class="reima-coll-dropdown" data-dropdown>
              <div class="reima-coll-dropdown-inner">
                {% comment %} Get unique product types from this collection {% endcomment %}
                {% assign product_types = '' | split: ',' %}
                {% for product in coll.products limit: 50 %}
                  {% unless product_types contains product.type %}
                    {% if product.type != blank %}
                      {% assign product_types = product_types | push: product.type %}
                    {% endif %}
                  {% endunless %}
                {% endfor %}

                {% if product_types.size > 1 %}
                  <div class="reima-coll-dropdown-col">
                    <h4 class="reima-coll-dropdown-title">SHOP BY TYPE</h4>
                    <ul class="reima-coll-dropdown-list">
                      {% for ptype in product_types limit: 6 %}
                        <li><a href="{{ coll.url }}?filter.p.product_type={{ ptype | url_encode }}">{{ ptype }}</a></li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                <div class="reima-coll-dropdown-col">
                  <h4 class="reima-coll-dropdown-title">FEATURED</h4>
                  <ul class="reima-coll-dropdown-list">
                    {% for product in coll.products limit: 5 %}
                      <li><a href="{{ product.url }}">{{ product.title | truncate: 35 }}</a></li>
                    {% endfor %}
                  </ul>
                  <a href="{{ coll.url }}" class="reima-coll-see-all">View All {{ coll.title }} →</a>
                </div>
              </div>
            </div>
          {% endif %}
        </li>
      {% endif %}
    {% endfor %}

    {% comment %} Fallback if nothing to show {% endcomment %}
    {% if collection_handles.size == 0 and show_sale == false and show_new == false %}
      <li class="reima-coll-nav-item">
        <a href="/collections/all" class="reima-coll-nav-link">Shop All</a>
      </li>
    {% endif %}
  </ul>
</nav>

<script>
(function() {
  // Dropdown hover handling
  document.addEventListener('DOMContentLoaded', function() {
    const items = document.querySelectorAll('.reima-coll-nav-item[data-nav-item]');
    let activeItem = null;
    let timeout = null;

    items.forEach(function(item) {
      const dropdown = item.querySelector('[data-dropdown]');
      if (!dropdown) return;

      item.addEventListener('mouseenter', function() {
        clearTimeout(timeout);
        if (activeItem && activeItem !== item) {
          activeItem.classList.remove('is-open');
        }
        item.classList.add('is-open');
        activeItem = item;
      });

      item.addEventListener('mouseleave', function() {
        timeout = setTimeout(function() {
          item.classList.remove('is-open');
          if (activeItem === item) activeItem = null;
        }, 100);
      });
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.reima-coll-nav-item')) {
        items.forEach(function(item) { item.classList.remove('is-open'); });
        activeItem = null;
      }
    });
  });
})();
</script>

<style>
.reima-coll-nav {
  display: flex;
  align-items: center;
  height: 100%;
  flex: 1;
}

.reima-coll-nav-list {
  display: flex;
  align-items: center;
  height: 100%;
  margin: 0;
  padding: 0;
  list-style: none;
}

.reima-coll-nav-item {
  position: static;
  height: 100%;
  display: flex;
  align-items: center;
}

.reima-coll-nav-link {
  display: flex;
  align-items: center;
  padding: 0 16px;
  height: 100%;
  font-size: 14px;
  font-weight: 400;
  color: #333;
  text-decoration: none;
  white-space: nowrap;
  position: relative;
  transition: color 0.2s ease;
}

.reima-coll-nav-link::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 16px;
  right: 16px;
  height: 3px;
  background: #c41230;
  transform: scaleX(0);
  transition: transform 0.25s ease;
}

.reima-coll-nav-item:hover .reima-coll-nav-link::after,
.reima-coll-nav-item.is-open .reima-coll-nav-link::after {
  transform: scaleX(1);
}

.reima-coll-sale .reima-coll-nav-link,
.reima-coll-nav-link.sale-link {
  color: #c41230;
  font-weight: 500;
}

/* Make header wrapper position relative */
.reima-header-style .header-wrapper {
  position: relative;
}

/* Dropdown */
.reima-coll-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  width: 100vw;
  margin-left: calc(-50vw + 50%);
  background: #fff;
  border-top: 3px solid #c41230;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.2s ease, visibility 0.2s ease;
}

.reima-coll-nav-item.is-open .reima-coll-dropdown {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
}

.reima-coll-dropdown-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px 48px;
  display: flex;
  gap: 48px;
}

.reima-coll-dropdown-col {
  flex: 1;
  min-width: 160px;
  max-width: 220px;
}

.reima-coll-dropdown-title {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: #333;
  letter-spacing: 0.08em;
  margin: 0 0 14px;
}

.reima-coll-dropdown-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.reima-coll-dropdown-list li {
  margin-bottom: 8px;
}

.reima-coll-dropdown-list a {
  font-size: 14px;
  color: #666;
  text-decoration: none;
  transition: color 0.2s ease;
}

.reima-coll-dropdown-list a:hover {
  color: #c41230;
}

.reima-coll-see-all {
  display: inline-block;
  margin-top: 14px;
  font-size: 14px;
  font-weight: 500;
  color: #c41230;
  text-decoration: none;
}

.reima-coll-see-all:hover {
  text-decoration: underline;
}

@media (max-width: 1024px) {
  .reima-coll-nav { display: none; }
}

@media (max-width: 1200px) {
  .reima-coll-nav-link {
    padding: 0 12px;
    font-size: 13px;
  }
  .reima-coll-dropdown-inner {
    padding: 24px 32px;
    gap: 32px;
  }
}
</style>
